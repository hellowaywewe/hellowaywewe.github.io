---
layout: post
title: 基于kubeadm工具部署Kubernetes集群
categories: Kubernetes
keywords: Kubernetes kubeadm
permalink: /Ubuntu/k8sDeploy
---

目前官方提供了3种部署Kubernetes（下面简写k8s）的方式：minikube，kubeadm和二进制包。
- minikube：用于自动化部署单节点k8s的工具，主要用于测试环境学习使用，不可用于生产环境
- kubeadm：用于自动化部署多节点k8s集群的工具，可用于生产环境，使用简单，利于初学者入门
- 二进制包：手动安装，非自动化部署，可用于生产环境需要感知每个组件及组件间的配置细节，遇到问题较难排查，但有利于全面理解k8s
本文为初学者展示如何使用kubeadm工具快速部署k8s集群，帮助初学者快速入门实践。

**目录**

* TOC
{:toc}

### 系统介绍
HOSTNAME | IP ADDR | 虚拟机OS | Specifications
:-: | :-: | :-: | :-:
kube-master | 192.168.43.174 | ubunru 16.04 | 1核4G
kube-node1 | 192.168.43.175 | ubunru 16.04 | 1核4G

注：CPU/内存要求至少2核/2G，但由于我们是用于测试操作用，不做生产用，选用1核也可以完成部署。

### 基础环境准备
本文直接使用root用户搭建k8s集群

##### 防火墙关闭（2台主机）
```shell
ufw disable
```

##### 修改对应主机名（2台主机）
修改方式参见[Ubuntu常用基础知识点](http://we.wewelove.cn/Ubuntu/generalBasics) 一文

##### 新增对应主机名及映射IP（2台主机）
修改方式参见s[Ubuntu常用基础知识点](http://we.wewelove.cn/Ubuntu/generalBasics) 一文

##### 时钟同步（2台主机）
修改方式参见[Ubuntu常用基础知识点](http://we.wewelove.cn/Ubuntu/generalBasics) 一文：
- 在k8s-master（192.168.43.174）机器上安装NTP
- 在k8s-node1（192.168.43.175）机器上安装ntpdate
- 在k8s-node1配置Crontab定时同步任务（可选）

##### 禁用swap（2台主机）
关闭swap即禁用虚拟内存，主要出于对性能的考虑
```shell
# 打开/etc/fstab文件，将swap那一行内容注释掉，然后关闭swap
sed -i '/swap/ s/^/#/' /etc/fstab
swapoff -a
```

### 正式部署
##### Docker安装（2台主机，版本：18.06.2~ce~3-0~ubuntu）
```shell
# 安装一些必要的系统工具
apt-get update
apt-get -y install apt-transport-https ca-certificates curl software-properties-common
# 安装GPG证书
curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
# 写入软件源信息
add-apt-repository "deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable"
# 更新并安装指定版本Docker-CE
apt-get -y install docker-ce=18.06.2~ce~3-0~ubuntu
```
使用`docker info `指令查看docker安装成功后的系统信息
![查看docker信息](/images/posts/kubernetes/docker_info.png "查看docker信息")

##### kubelet，kubeadm和kubectl安装(2台主机，版本：1.15.0-00)
使用kubeadm工具部署k8s集群，需要访问google拉取kubelet等相关组件的镜像，由于镜像站点在国外，访问速度慢，
镜像拉取常常不成功，导致集群自动化部署失败。因此，国内用户可选用访问[阿里云镜像站点](https://developer.aliyun.com/mirror/)
获取k8s镜像。
```
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - 
cat <<EOF >/etc/apt/sources.list.d/kubernetes.list
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
EOF  
apt-get update
apt-get install -y kubelet=1.15.0-00 kubeadm=1.15.0-00 kubectl=1.15.0-00
# 确保版本不会被自动更新
apt-mark hold kubelet=1.15.0-00 kubeadm=1.15.0-00 kubectl=1.15.0-00
```

